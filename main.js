const translations = {
    pt: {
        role: "Gestão Comercial e Projetos Digitais",
        section_summary: "Resumo",
        summary_text: "Profissional de Gestão Comercial e Projetos Digitais com vivência em vendas consultivas e liderança de equipes. Atualmente desenvolvo projetos autônomos e busco recolocação no mercado para somar resultados com minha expertise em negociação e criação de materiais estratégicos de venda.",
        section_experience: "Experiencia Profissional",
        job1_title: "Analista de Vendas e Processos",
        job1_desc1: "<strong>Vendas Consultivas:</strong> Gestão do ciclo de vendas consultivas de ativos imobiliários de alto valor.",
        job1_desc2: "<strong>Processos:</strong> Implementação de análise de dados para qualificação de leads e otimização do funil de vendas.",
        job2_title: "Presidente e Fundador",
        job2_desc1: "<strong>Gestão de Equipe:</strong> Liderança executiva de equipe multidisciplinar (30 membros). Definição de metas estratégicas e rotinas operacionais.",
        job2_desc2: "<strong>Financeiro:</strong> Reestruturação financeira completa e captação estratégica de recursos, garantindo superávit operacional para a gestão seguinte.",
        job3_title: "Produtor Digital e Gestor de Projetos",
        job3_company: "Autônomo",
        job3_desc1: "<strong>Projetos Web:</strong> Gestão e execução de projetos digitais end-to-end. Desenvolvimento de interfaces web focadas em performance e conversão.",
        job3_desc2: "<strong>Mídia e Design:</strong> Produção audiovisual para eventos corporativos, incluindo cobertura e edição ágil (ex: Fórum Ambição 2030).",
        job3_desc3: "<strong>Ferramentas:</strong> Criação de ferramentas de automação de processos para otimização de cálculos e rotinas.",
        job4_title: "Assistente de Importação",
        job4_desc1: "<strong>Comércio Exterior:</strong> Operacionalização de processos de importação/exportação e gestão de relacionamento com cadeia de suprimentos internacional.",
        section_skills: "Habilidades Técnicas",
        skill_cat1: "Design e Audiovisual",
        skill_cat2: "Negócios e Ferramentas",
        section_education: "Formação Acadêmica",
        edu1_title: "Relações Internacionais (Bacharelado)",
        edu2_title: "Técnico em Administração",
        section_languages: "Idiomas",
        lang1_name: "Português",
        lang1_details: "Nativo",
        lang2_name: "Inglês",
        lang2_details: "Fluente (Vivência Internacional & Comércio Exterior)",
        lang3_name: "Espanhol",
        lang3_details: "Profissional (Foco em leitura e compreensão corporativa)",
        lang4_name: "Africâner",
        lang4_details: "Básico (Noções gerais)",
        section_activities: "Atividades Extracurriculares",
        act1_desc: "Gestão estratégica de Imagem Pública e comunicação corporativa para o Interact e Rotaract Club.",
        act2_title: "Intercâmbio (Rotary Youth Exchange)",
        act2_desc: "África do Sul."
    },
    en: {
        role: "Commercial Management & Digital Projects",
        section_summary: "Summary",
        summary_text: "Professional with experience in Commercial Management and Digital Projects, including consultative sales and team leadership. Currently working as a freelancer, I am actively seeking new opportunities in the corporate market to leverage my skills in sales strategy and digital content creation.",
        section_experience: "Professional Experience",
        job1_title: "Sales and Process Analyst",
        job1_desc1: "<strong>Consultative Sales:</strong> Management of consultative sales cycles for high-value real estate assets.",
        job1_desc2: "<strong>Processes:</strong> Implementation of data analysis for lead qualification and sales funnel optimization.",
        job2_title: "President and Founder",
        job2_desc1: "<strong>Team Management:</strong> Executive leadership of a multidisciplinary team (30 members). Definition of strategic goals and operational routines.",
        job2_desc2: "<strong>Financial:</strong> Complete financial restructuring and strategic fundraising, ensuring operational surplus for the next management.",
        job3_title: "Digital Producer and Project Manager",
        job3_company: "Freelance",
        job3_desc1: "<strong>Web Projects:</strong> Management and execution of end-to-end digital projects. Development of performance-focused web interfaces.",
        job3_desc2: "<strong>Media & Design:</strong> Audiovisual production for corporate events, including coverage and agile editing (e.g., Ambition 2030 Forum).",
        job3_desc3: "<strong>Tools:</strong> Creation of process automation tools for calculation and routine optimization.",
        job4_title: "Import Assistant",
        job4_desc1: "<strong>Foreign Trade:</strong> Operationalization of import/export processes and relationship management with the international supply chain.",
        section_skills: "Technical Skills",
        skill_cat1: "Design & Audiovisual",
        skill_cat2: "Business & Tools",
        section_education: "Education",
        edu1_title: "International Relations (Bachelor's)",
        edu2_title: "Business Administration Technician",
        section_languages: "Languages",
        lang1_name: "Portuguese",
        lang1_details: "Native",
        lang2_name: "English",
        lang2_details: "Fluent (International Experience & Foreign Trade)",
        lang3_name: "Spanish",
        lang3_details: "Professional (Focus on corporate reading and comprehension)",
        lang4_name: "Afrikaans",
        lang4_details: "Basic (General notions)",
        section_activities: "Extracurricular Activities",
        act1_desc: "Strategic management of Public Image and corporate communication for Interact and Rotaract Club.",
        act2_title: "Exchange Program (Rotary Youth Exchange)",
        act2_desc: "South Africa."
    },
    es: {
        role: "Gestión Comercial y Proyectos Digitales",
        section_summary: "Resumen",
        summary_text: "Profesional con experiencia en Gestión Comercial y Proyectos Digitales, incluyendo ventas consultivas y liderazgo de equipos. Actualmente trabajo como autónomo, pero busco activamente nuevas oportunidades en el mercado corporativo para aplicar mis habilidades en estrategia comercial y creación de contenido digital.",
        section_experience: "Experiencia Profesional",
        job1_title: "Analista de Ventas y Procesos",
        job1_desc1: "<strong>Ventas Consultivas:</strong> Gestão del ciclo de ventas consultivas de ativos imobiliarios de alto valor.",
        job1_desc2: "<strong>Procesos:</strong> Implementación de análisis de dados para calificación de leads y optimización del embudo de ventas.",
        job2_title: "Presidente y Fundador",
        job2_desc1: "<strong>Gestión de Equipo:</strong> Liderazgo executivo de equipo multidisciplinario (30 membros). Definición de metas estratégicas e rutinas operativas.",
        job2_desc2: "<strong>Financiero:</strong> Reestructuración financiera completa y captación estratégica de recursos, garantizando superávit operativo para la gestión siguiente.",
        job3_title: "Productor Digital y Gestor de Proyectos",
        job3_company: "Autónomo",
        job3_desc1: "<strong>Proyectos Web:</strong> Gestión y ejecución de proyectos digitales end-to-end. Desarrollo de interfaces web enfocadas en rendimiento y conversión.",
        job3_desc2: "<strong>Medios y Diseño:</strong> Producción audiovisual para eventos corporativos, incluyendo cobertura y edición ágil (ej: Foro Ambición 2030).",
        job3_desc3: "<strong>Herramientas:</strong> Creación de herramientas de automatización de procesos para optimización de cálculos y rutinas.",
        job4_title: "Asistente de Importación",
        job4_desc1: "<strong>Comercio Exterior:</strong> Operacionalização de processos de importação/exportação e gestão de relações com a cadeia de suprimento internacional.",
        section_skills: "Habilidades Técnicas",
        skill_cat1: "Diseño y Audiovisual",
        skill_cat2: "Negocios y Herramientas",
        section_education: "Formación Académica",
        edu1_title: "Relaciones Internacionales (Licenciatura)",
        edu2_title: "Técnico em Administração",
        section_languages: "Idiomas",
        lang1_name: "Portugués",
        lang1_details: "Nativo",
        lang2_name: "Inglés",
        lang2_details: "Fluido (Vivencia Internacional y Comercio Exterior)",
        lang3_name: "Español",
        lang3_details: "Profesional (Enfoque en lectura y comprensión corporativa)",
        lang4_name: "Afrikáans",
        lang4_details: "Básico (Nociones generales)",
        section_activities: "Actividades Extracurriculares",
        act1_desc: "Gestión estratégica de Imagen Pública y comunicación corporativa para Interact y Rotaract Club.",
        act2_title: "Intercambio (Rotary Youth Exchange)",
        act2_desc: "Sudáfrica."
    }
};

function setLanguage(lang) {
    document.documentElement.lang = lang;

    // Update buttons
    document.querySelectorAll('.lang-btn').forEach(btn => {
        const isActive = btn.textContent.toLowerCase() === lang;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });

    // Update text
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang][key]) {
            element.innerHTML = translations[lang][key];
        }
    });
}

// Theme Toggle Logic
document.addEventListener('DOMContentLoaded', () => {
    const themeToggleBtns = document.querySelectorAll('.theme-toggle');
    const htmlElement = document.documentElement;

    const applyTheme = (isDark, persist = false) => {
        htmlElement.classList.toggle('dark', isDark);
        if (persist) {
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        themeToggleBtns.forEach(btn => btn.setAttribute('aria-pressed', isDark ? 'true' : 'false'));
        window.dispatchEvent(new CustomEvent('themechange', { detail: { isDark } }));
    };

    const storedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialDark = storedTheme ? storedTheme === 'dark' : prefersDark;
    applyTheme(initialDark);

    if (!storedTheme && window.matchMedia) {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', (event) => applyTheme(event.matches));
    }

    themeToggleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const nextState = !htmlElement.classList.contains('dark');
            applyTheme(nextState, true);
        });
    });

    // Ensure language buttons have correct aria-pressed on load
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.setAttribute('aria-pressed', btn.classList.contains('active') ? 'true' : 'false');
    });

    // Initialize Sidebar Logic
    generateOutline('#resume-view');
    setupScrollSpy('#resume-view');
});

// View Switching Logic
function switchView(viewName) {
    const resumeView = document.getElementById('resume-view');
    const playgroundView = document.getElementById('playground-view');
    
    // Update Sidebar Buttons
    document.querySelectorAll('.sidebar-item').forEach(btn => {
        btn.classList.remove('active');
        const target = btn.getAttribute('data-target');
        if (target === viewName) {
            btn.classList.add('active');
        }
    });

    const isResume = viewName === 'resume';
    const hideEl = isResume ? playgroundView : resumeView;
    const showEl = isResume ? resumeView : playgroundView;

    // Use transition helper
    animateTransition(hideEl, showEl, () => {
        if (isResume && Experiments) {
            Experiments.stopCurrent();
        }
        const selector = isResume ? '#resume-view' : '#playground-view';
        generateOutline(selector);
        setTimeout(() => setupScrollSpy(selector), 100);
    });
}

// Utility: debounce
function debounce(fn, wait) {
    let t;
    return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
    };
}

// Experiment Logic
function openExperiment(type) {
    const dashboard = document.getElementById('playground-dashboard');
    const container = document.getElementById('experiment-container');
    const views = document.querySelectorAll('.experiment-view');
    const targetView = document.getElementById(`${type}-view`);

    if (!targetView) return;

    // Animate Dashboard -> Experiment Container
    animateTransition(dashboard, container, () => {
        // Ensure only target view is visible within container
        views.forEach(v => v.style.display = 'none');
        targetView.style.display = 'block';

        // Start the experiment logic
        initExperimentLogic(type, targetView);
    });
}

function initExperimentLogic(type, view) {
        // Initialize experiment with options from controls
        const formatVal = (v) => {
            if (typeof v !== 'number') return v;
            if (Math.abs(v) >= 100) return Math.round(v);
            if (Math.abs(v) >= 1) return Math.round(v * 100) / 100;
            // small numbers: show up to 5 significant digits
            return parseFloat(v.toPrecision(4));
        };

        const readOptions = () => {
            const opts = {};
            const controls = view.querySelectorAll('.exp-control');
            controls.forEach(ctrl => {
                const name = ctrl.name;
                let val = ctrl.value;
                // coerce numeric values
                if (val !== undefined && val !== null && val !== '') {
                    if (val.indexOf('.') >= 0) val = parseFloat(val);
                    else val = parseFloat(val);
                }
                opts[name] = val;
                // update label if exists
                const label = view.querySelector(`#${type}-${name}-label`) || view.querySelector(`#${type}-${name}-label`);
                if (label) label.textContent = formatVal(val);
            });
            return opts;
        };

        const startWithOptions = (opts) => {
            if (Experiments && Experiments[type]) {
                // Stop previous first
                Experiments.stopCurrent();

                // Start new experiment and store the returned instance
                const result = Experiments[type](`${type}Canvas`, opts);

                // Support older-style cleanup functions (function) or the new instance object
                if (typeof result === 'function') {
                    Experiments.currentInstance = { cleanup: result, setOptions: null };
                } else if (result && typeof result === 'object') {
                    Experiments.currentInstance = result;
                } else {
                    Experiments.currentInstance = null;
                }

                Experiments.activeId = type;
            }
        };

        // Start immediately
        startWithOptions(readOptions());

        // Wire controls to re-init experiment on change (debounced)
        if (view._expBound && Array.isArray(view._expBound)) {
            // remove old listeners
            view._expBound.forEach(b => b.el.removeEventListener('input', b.handler));
        }
        const bound = [];
        view.querySelectorAll('.exp-control').forEach(ctrl => {
            const handler = debounce(() => {
                const opts = readOptions();
                // If the experiment supports live updates, prefer setOptions
                if (Experiments && Experiments.currentInstance && typeof Experiments.currentInstance.setOptions === 'function') {
                    try {
                        const res = Experiments.currentInstance.setOptions(opts);
                        // If the instance signals a re-init is required, restart entirely
                        if (res && res.requiresReinit) {
                            startWithOptions(opts);
                        }
                        return;
                    } catch (err) {
                        console.warn('setOptions failed, reinitializing:', err);
                        startWithOptions(opts);
                        return;
                    }
                }

                // Fallback: re-init
                startWithOptions(opts);
            }, 250);
            ctrl.addEventListener('input', handler);
            bound.push({ el: ctrl, handler });
        });
        view._expBound = bound;

        generateOutline('#playground-view');
        setupScrollSpy('#playground-view');
}

function closeExperiment() {
    const dashboard = document.getElementById('playground-dashboard');
    const container = document.getElementById('experiment-container');
    
    // Animate Container -> Dashboard
    animateTransition(container, dashboard, () => {
        // Capture active id so we can remove listeners, then stop experiment
        const prevActive = Experiments ? Experiments.activeId : null;
        if (Experiments) Experiments.stopCurrent();
        if (prevActive) {
            const activeView = document.getElementById(`${prevActive}-view`);
            if (activeView && activeView._expBound) {
                activeView._expBound.forEach(b => b.el.removeEventListener('input', b.handler));
                activeView._expBound = null;
            }
        }
        generateOutline('#playground-view');
        setupScrollSpy('#playground-view');
    });
}

// Make functions global for HTML access
window.openExperiment = openExperiment;
window.closeExperiment = closeExperiment;
window.switchView = switchView;
window.setLanguage = setLanguage;
window.toggleSidebar = toggleSidebar;
window.toggleDesktopSidebar = toggleDesktopSidebar;

// Sidebar Toggle Logic
function toggleSidebar() {
    const sidebar = document.querySelector('.doc-sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const isOpen = sidebar.classList.contains('open');
    
    if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    } else {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
}

function toggleDesktopSidebar() {
    document.body.classList.toggle('sidebar-collapsed');
    // Trigger resize event for canvas experiments to adjust
    setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
    }, 300);
}

// Close sidebar when clicking a link on mobile
document.addEventListener('DOMContentLoaded', () => {
    // ...existing code...
    
    // Close sidebar on link click (mobile)
    const sidebarLinks = document.querySelectorAll('.sidebar-item, .outline-item');
    sidebarLinks.forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 900) {
                const sidebar = document.querySelector('.doc-sidebar');
                if (sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            }
        });
    });
});

// Outline Generation Logic
function generateOutline(rootSelector = '#resume-view') {
    const outlineList = document.querySelector('.outline-list');
    const root = document.querySelector(rootSelector);
    if (!outlineList || !root) return;
    const sections = Array.from(root.querySelectorAll('h2')).filter(section => section.offsetParent !== null);
    
    outlineList.innerHTML = ''; // Clear existing

    if (!sections.length) {
        const empty = document.createElement('div');
        empty.className = 'outline-empty';
        empty.textContent = 'Sem seções disponíveis.';
        outlineList.appendChild(empty);
        return;
    }

    sections.forEach((section, index) => {
        if (!section.id) {
            section.id = `${rootSelector.replace('#', '')}-section-${index}`;
        }

        const link = document.createElement('a');
        link.className = 'outline-item';
        link.textContent = section.textContent;
        link.href = `#${section.id}`;
        
        link.addEventListener('click', (e) => {
            e.preventDefault();
            section.scrollIntoView({ behavior: 'smooth' });
        });

        outlineList.appendChild(link);
    });
}

// Scroll Spy Logic (Highlight active section in outline)
function setupScrollSpy(rootSelector = '#resume-view') {
    const sections = Array.from(document.querySelectorAll(`${rootSelector} h2`)).filter(section => section.offsetParent !== null);
    const outlineItems = document.querySelectorAll('.outline-item');

    if (!sections.length || !outlineItems.length) {
        return;
    }

    const observerOptions = {
        root: null,
        rootMargin: '-10% 0px -80% 0px', // Trigger when section is near top
        threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Remove active class from all
                outlineItems.forEach(item => item.classList.remove('active'));
                
                // Add active class to corresponding link
                const id = entry.target.id;
                const activeLink = document.querySelector(`.outline-item[href="#${id}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
            }
        });
    }, observerOptions);

    sections.forEach(section => observer.observe(section));
}

/*
 * Helper to animate elements out before hiding them,
 * and animate elements in after showing them.
 */
function animateTransition(hideElement, showElement, onComplete) {
    if (!hideElement || !showElement) {
        if (hideElement) hideElement.style.display = 'none';
        if (showElement) showElement.style.display = 'block';
        if (onComplete) onComplete();
        return;
    }

    // 1. Animate Out
    hideElement.classList.add('anim-fade-out');

    const handleOutEnd = () => {
        hideElement.classList.remove('anim-fade-out');
        hideElement.style.display = 'none';
        hideElement.removeEventListener('animationend', handleOutEnd);

        // 2. Switch
        showElement.style.display = 'block';
        showElement.classList.add('anim-fade-in');

        // 3. Animate In
        const handleInEnd = () => {
            showElement.classList.remove('anim-fade-in');
            showElement.removeEventListener('animationend', handleInEnd);
            if (onComplete) onComplete();
        };
        showElement.addEventListener('animationend', handleInEnd);
    };

    hideElement.addEventListener('animationend', handleOutEnd);
}
