const translations = {
    pt: {
        role: "Gestão Comercial e Projetos Digitais",
        section_summary: "Resumo",
        summary_text: "Gestor Comercial e de Projetos que integra visão analítica e produção audiovisual estratégica para impulsionar resultados. Com histórico de reestruturação financeira e otimização de processos de vendas, atuo como arquiteto de soluções, utilizando dados e comunicação visual de alto impacto para destravar negócios e maximizar o engajamento.",
        section_experience: "Experiência Profissional",
        job1_title: "Analista de Vendas e Processos",
        job1_desc1: "Gerenciou ciclo completo de vendas consultivas para ativos imobiliários com VGV entre R$ 120 mil e R$ 2,5 milhões (com transações de até R$ 13 milhões).",
        job1_desc2: "Implementou metodologia de análise de dados para qualificação de leads, resultando na otimização significativa da taxa de conversão do funil de vendas.",
        job1_desc3: "Otimizou processos comerciais, reduzindo o tempo médio do ciclo de vendas e aumentando a previsibilidade de receita.",
        job2_title: "Presidente e Fundador",
        job2_desc1: "Fundou e liderou equipe multidisciplinar de 30 membros, implementando rotinas operacionais que aumentaram a eficiência na execução de projetos estudantis.",
        job2_desc2: "Orquestrou reestruturação financeira partindo do zero, revertendo o cenário inicial e entregando um superávit operacional líquido de R$ 4.000,00 para a gestão sucessora.",
        job2_desc3: "Desenvolveu e executou estratégias de captação de recursos e parcerias que viabilizaram a operação e expandiram o orçamento anual.",
        job3_title: "Produtor Digital e Gestor de Projetos",
        job3_company: "Autônomo",
        job3_desc1: "<strong>Gestão de Projetos Digitais:</strong> Condução de projetos end-to-end, desde o desenvolvimento de interfaces web focadas em conversão (CRO) até a criação de ferramentas de automação de processos.",
        job3_desc2: "<strong>Comunicação Estratégica:</strong> Produção ágil de conteúdo audiovisual para comunicação corporativa (ex: cobertura do Fórum Ambição 2030), utilizando vídeo e design como ferramentas de suporte a vendas e engajamento.",
        job3_desc3: "Desenvolveu soluções web personalizadas (HTML/CSS/JS) alinhadas a objetivos de negócio, priorizando performance e UX.",
        job4_title: "Assistente de Importação",
        job4_desc1: "<strong>Comércio Exterior:</strong> Operacionalização de processos de importação/exportação e gestão de relacionamento com cadeia de suprimentos internacional.",
        section_skills: "Habilidades Técnicas",
        skill_cat1: "Design e Audiovisual",
        skill_cat2: "Negócios e Ferramentas",
        section_education: "Formação Acadêmica",
        edu1_title: "Relações Internacionais (Bacharelado)",
        edu2_title: "Técnico em Administração",
        section_languages: "Idiomas",
        lang1_name: "Português",
        lang1_details: "Nativo",
        lang2_name: "Inglês",
        lang2_details: "Fluente (Vivência Internacional & Comércio Exterior)",
        lang3_name: "Espanhol",
        lang3_details: "Profissional (Foco em leitura e compreensão corporativa)",
        lang4_name: "Africâner",
        lang4_details: "Básico (Noções gerais)",
        section_activities: "Atividades Extracurriculares",
        act1_desc: "Gestão estratégica de Imagem Pública e comunicação corporativa para o Interact e Rotaract Club.",
        act2_title: "Intercâmbio (Rotary Youth Exchange)",
        act2_desc: "África do Sul."
    },
    en: {
        role: "Commercial Management & Digital Projects",
        section_summary: "Summary",
        summary_text: "Project and Commercial Manager integrating analytical vision with strategic audiovisual production to drive results. With a track record in financial restructuring and sales process optimization, I act as a solutions architect, leveraging data and high-impact visual communication to unlock business opportunities and maximize engagement.",
        section_experience: "Professional Experience",
        job1_title: "Sales and Process Analyst",
        job1_desc1: "Managed full consultative sales cycle for real estate assets with GMV between R$ 120k and R$ 2.5M (reaching up to R$ 13M).",
        job1_desc2: "Implemented data analysis methodology for lead qualification, significantly optimizing sales funnel conversion rates.",
        job1_desc3: "Optimized commercial processes, reducing average sales cycle time and increasing revenue predictability.",
        job2_title: "President and Founder",
        job2_desc1: "Founded and led a multidisciplinary team of 30 members, implementing operational routines that increased efficiency in student project execution.",
        job2_desc2: "Orchestrated financial restructuring from scratch, delivering a net operational surplus of R$ 4,000.00 to the succeeding administration.",
        job2_desc3: "Developed and executed fundraising and partnership strategies that enabled operations and expanded the annual budget.",
        job3_title: "Digital Producer and Project Manager",
        job3_company: "Freelance",
        job3_desc1: "<strong>Digital Project Management:</strong> End-to-end project leadership, from developing conversion-focused web interfaces (CRO) to creating process automation tools.",
        job3_desc2: "<strong>Strategic Communication:</strong> Agile audiovisual content production for corporate communication (e.g., Ambition 2030 Forum coverage), using video and design as tools for sales support and engagement.",
        job3_desc3: "Developed customized web solutions (HTML/CSS/JS) aligned with business goals, prioritizing performance and UX.",
        job4_title: "Import Assistant",
        job4_desc1: "<strong>Foreign Trade:</strong> Operationalization of import/export processes and relationship management with the international supply chain.",
        section_skills: "Technical Skills",
        skill_cat1: "Design & Audiovisual",
        skill_cat2: "Business & Tools",
        section_education: "Education",
        edu1_title: "International Relations (Bachelor's)",
        edu2_title: "Business Administration Technician",
        section_languages: "Languages",
        lang1_name: "Portuguese",
        lang1_details: "Native",
        lang2_name: "English",
        lang2_details: "Fluent (International Experience & Foreign Trade)",
        lang3_name: "Spanish",
        lang3_details: "Professional (Focus on corporate reading and comprehension)",
        lang4_name: "Afrikaans",
        lang4_details: "Basic (General notions)",
        section_activities: "Extracurricular Activities",
        act1_desc: "Strategic management of Public Image and corporate communication for Interact and Rotaract Club.",
        act2_title: "Exchange Program (Rotary Youth Exchange)",
        act2_desc: "South Africa."
    },
    es: {
        role: "Gestión Comercial y Proyectos Digitales",
        section_summary: "Resumen",
        summary_text: "Gestor Comercial y de Proyectos que integra visión analítica y producción audiovisual estratégica para impulsar resultados. Con historial en reestructuración financiera y optimización de procesos de ventas, actúo como arquitecto de soluciones, utilizando datos y comunicación visual de alto impacto para desbloquear negocios y maximizar el compromiso.",
        section_experience: "Experiencia Profesional",
        job1_title: "Analista de Ventas y Procesos",
        job1_desc1: "Gestionó ciclo completo de ventas consultivas para activos inmobiliarios con VGV entre R$ 120 mil y R$ 2,5 millones (alcanzando hasta R$ 13 millones).",
        job1_desc2: "Implementó metodología de análisis de datos para calificación de leads, resultando en una optimización significativa de la tasa de conversión del embudo de ventas.",
        job1_desc3: "Optimizó procesos comerciales, reduciendo el tiempo medio del ciclo de ventas y aumentando la previsibilidad de ingresos.",
        job2_title: "Presidente y Fundador",
        job2_desc1: "Fundó y lideró equipo multidisciplinario de 30 miembros, implementando rutinas operativas que aumentaron la eficiencia en la ejecución de proyectos estudiantiles.",
        job2_desc2: "Orquestó reestructuración financiera partiendo de cero, entregando un superávit operativo neto de R$ 4.000,00 a la gestión sucesora.",
        job2_desc3: "Desarrolló y ejecutó estrategias de captación de recursos y alianzas que viabilizaron la operación y expandieron el presupuesto anual.",
        job3_title: "Productor Digital y Gestor de Proyectos",
        job3_company: "Autónomo",
        job3_desc1: "<strong>Gestión de Proyectos Digitales:</strong> Conducción de proyectos end-to-end, desde el desarrollo de interfaces web enfocadas en conversión (CRO) hasta la creación de herramientas de automatización.",
        job3_desc2: "<strong>Comunicación Estratégica:</strong> Producción ágil de contenido audiovisual para comunicación corporativa (ej: cobertura del Foro Ambición 2030), utilizando video y diseño como herramientas de soporte a ventas.",
        job3_desc3: "Desarrolló soluciones web personalizadas (HTML/CSS/JS) alineadas a objetivos de negocio, priorizando rendimiento y UX.",
        job4_title: "Asistente de Importación",
        job4_desc1: "<strong>Comercio Exterior:</strong> Operacionalização de processos de importação/exportação e gestão de relações com a cadeia de suprimento internacional.",
        section_skills: "Habilidades Técnicas",
        skill_cat1: "Diseño y Audiovisual",
        skill_cat2: "Negocios y Herramientas",
        section_education: "Formación Académica",
        edu1_title: "Relaciones Internacionales (Licenciatura)",
        edu2_title: "Técnico em Administração",
        section_languages: "Idiomas",
        lang1_name: "Portugués",
        lang1_details: "Nativo",
        lang2_name: "Inglés",
        lang2_details: "Fluido (Vivencia Internacional y Comercio Exterior)",
        lang3_name: "Español",
        lang3_details: "Profesional (Enfoque en lectura y comprensión corporativa)",
        lang4_name: "Afrikáans",
        lang4_details: "Básico (Nociones generales)",
        section_activities: "Actividades Extracurriculares",
        act1_desc: "Gestión estratégica de Imagen Pública y comunicación corporativa para Interact y Rotaract Club.",
        act2_title: "Intercambio (Rotary Youth Exchange)",
        act2_desc: "Sudáfrica."
    }
};

function setLanguage(lang) {
    document.documentElement.lang = lang;

    // Update buttons
    document.querySelectorAll('.lang-btn').forEach(btn => {
        const isActive = btn.textContent.toLowerCase() === lang;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });

    // Update text
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang][key]) {
            element.innerHTML = translations[lang][key];
        }
    });
}

// Theme Toggle Logic
document.addEventListener('DOMContentLoaded', () => {
    const themeToggleBtns = document.querySelectorAll('.theme-toggle');
    const htmlElement = document.documentElement;

    const applyTheme = (isDark, persist = false) => {
        htmlElement.classList.toggle('dark', isDark);
        if (persist) {
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        themeToggleBtns.forEach(btn => btn.setAttribute('aria-pressed', isDark ? 'true' : 'false'));
        window.dispatchEvent(new CustomEvent('themechange', { detail: { isDark } }));
    };

    const storedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialDark = storedTheme ? storedTheme === 'dark' : prefersDark;
    applyTheme(initialDark);

    if (!storedTheme && window.matchMedia) {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', (event) => applyTheme(event.matches));
    }

    themeToggleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const nextState = !htmlElement.classList.contains('dark');
            applyTheme(nextState, true);
        });
    });

    // Ensure language buttons have correct aria-pressed on load
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.setAttribute('aria-pressed', btn.classList.contains('active') ? 'true' : 'false');
    });

    // Initialize Sidebar Logic
    generateOutline('#resume-view');
    setupScrollSpy('#resume-view');
});

// View Switching Logic
function switchView(viewName) {
    const resumeView = document.getElementById('resume-view');
    const playgroundView = document.getElementById('playground-view');
    
    // Update Sidebar Buttons
    document.querySelectorAll('.sidebar-item').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.trim().toLowerCase().includes(viewName)) {
            btn.classList.add('active');
        }
    });

    const isResume = viewName === 'resume';
    const hideEl = isResume ? playgroundView : resumeView;
    const showEl = isResume ? resumeView : playgroundView;

    // Use transition helper
    animateTransition(hideEl, showEl, () => {
        if (isResume && Experiments) {
            Experiments.stopCurrent();
        }
        const selector = isResume ? '#resume-view' : '#playground-view';
        generateOutline(selector);
        setTimeout(() => setupScrollSpy(selector), 100);
    });
}

// Utility: debounce
function debounce(fn, wait) {
    let t;
    return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
    };
}

// Experiment Logic
function openExperiment(type) {
    const dashboard = document.getElementById('playground-dashboard');
    const container = document.getElementById('experiment-container');
    const views = document.querySelectorAll('.experiment-view');
    const targetView = document.getElementById(`${type}-view`);

    if (!targetView) return;

    // Animate Dashboard -> Experiment Container
    animateTransition(dashboard, container, () => {
        // Ensure only target view is visible within container
        views.forEach(v => v.style.display = 'none');
        targetView.style.display = 'block';

        // Start the experiment logic
        initExperimentLogic(type, targetView);
    });
}

function initExperimentLogic(type, view) {
        // Initialize experiment with options from controls
        const formatVal = (v) => {
            if (typeof v !== 'number') return v;
            if (Math.abs(v) >= 100) return Math.round(v);
            if (Math.abs(v) >= 1) return Math.round(v * 100) / 100;
            // small numbers: show up to 5 significant digits
            return parseFloat(v.toPrecision(4));
        };

        const readOptions = () => {
            const opts = {};
            const controls = view.querySelectorAll('.exp-control');
            controls.forEach(ctrl => {
                const name = ctrl.name;
                let val = ctrl.value;
                // coerce numeric values
                if (val !== undefined && val !== null && val !== '') {
                    if (val.indexOf('.') >= 0) val = parseFloat(val);
                    else val = parseFloat(val);
                }
                opts[name] = val;
                // update label if exists
                const label = view.querySelector(`#${type}-${name}-label`) || view.querySelector(`#${type}-${name}-label`);
                if (label) label.textContent = formatVal(val);
            });
            return opts;
        };

        const startWithOptions = (opts) => {
            if (Experiments && Experiments[type]) {
                // Stop previous first
                Experiments.stopCurrent();

                // Start new experiment and store the returned instance
                const result = Experiments[type](`${type}Canvas`, opts);

                // Support older-style cleanup functions (function) or the new instance object
                if (typeof result === 'function') {
                    Experiments.currentInstance = { cleanup: result, setOptions: null };
                } else if (result && typeof result === 'object') {
                    Experiments.currentInstance = result;
                } else {
                    Experiments.currentInstance = null;
                }

                Experiments.activeId = type;
            }
        };

        // Start immediately
        startWithOptions(readOptions());

        // Wire controls to re-init experiment on change (debounced)
        if (view._expBound && Array.isArray(view._expBound)) {
            // remove old listeners
            view._expBound.forEach(b => b.el.removeEventListener('input', b.handler));
        }
        const bound = [];
        view.querySelectorAll('.exp-control').forEach(ctrl => {
            const handler = debounce(() => {
                const opts = readOptions();
                // If the experiment supports live updates, prefer setOptions
                if (Experiments && Experiments.currentInstance && typeof Experiments.currentInstance.setOptions === 'function') {
                    try {
                        const res = Experiments.currentInstance.setOptions(opts);
                        // If the instance signals a re-init is required, restart entirely
                        if (res && res.requiresReinit) {
                            startWithOptions(opts);
                        }
                        return;
                    } catch (err) {
                        console.warn('setOptions failed, reinitializing:', err);
                        startWithOptions(opts);
                        return;
                    }
                }

                // Fallback: re-init
                startWithOptions(opts);
            }, 250);
            ctrl.addEventListener('input', handler);
            bound.push({ el: ctrl, handler });
        });
        view._expBound = bound;

        generateOutline('#playground-view');
        setupScrollSpy('#playground-view');
}

function closeExperiment() {
    const dashboard = document.getElementById('playground-dashboard');
    const container = document.getElementById('experiment-container');
    
    // Animate Container -> Dashboard
    animateTransition(container, dashboard, () => {
        // Capture active id so we can remove listeners, then stop experiment
        const prevActive = Experiments ? Experiments.activeId : null;
        if (Experiments) Experiments.stopCurrent();
        if (prevActive) {
            const activeView = document.getElementById(`${prevActive}-view`);
            if (activeView && activeView._expBound) {
                activeView._expBound.forEach(b => b.el.removeEventListener('input', b.handler));
                activeView._expBound = null;
            }
        }
        generateOutline('#playground-view');
        setupScrollSpy('#playground-view');
    });
}

// Make functions global for HTML access
window.openExperiment = openExperiment;
window.closeExperiment = closeExperiment;
window.switchView = switchView;
window.setLanguage = setLanguage;
window.toggleSidebar = toggleSidebar;
window.toggleDesktopSidebar = toggleDesktopSidebar;

// Sidebar Toggle Logic
function toggleSidebar() {
    const sidebar = document.querySelector('.doc-sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const isOpen = sidebar.classList.contains('open');
    
    if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    } else {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
}

function toggleDesktopSidebar() {
    document.body.classList.toggle('sidebar-collapsed');
    // Trigger resize event for canvas experiments to adjust
    setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
    }, 300);
}

// Close sidebar when clicking a link on mobile
document.addEventListener('DOMContentLoaded', () => {
    // ...existing code...
    
    // Close sidebar on link click (mobile)
    const sidebarLinks = document.querySelectorAll('.sidebar-item, .outline-item');
    sidebarLinks.forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 900) {
                const sidebar = document.querySelector('.doc-sidebar');
                if (sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            }
        });
    });
});

// Outline Generation Logic
function generateOutline(rootSelector = '#resume-view') {
    const outlineList = document.querySelector('.outline-list');
    const root = document.querySelector(rootSelector);
    if (!outlineList || !root) return;
    const sections = Array.from(root.querySelectorAll('h2')).filter(section => section.offsetParent !== null);
    
    outlineList.innerHTML = ''; // Clear existing

    if (!sections.length) {
        const empty = document.createElement('div');
        empty.className = 'outline-empty';
        empty.textContent = 'Sem seções disponíveis.';
        outlineList.appendChild(empty);
        return;
    }

    sections.forEach((section, index) => {
        if (!section.id) {
            section.id = `${rootSelector.replace('#', '')}-section-${index}`;
        }

        const link = document.createElement('a');
        link.className = 'outline-item';
        link.textContent = section.textContent;
        link.href = `#${section.id}`;
        
        link.addEventListener('click', (e) => {
            e.preventDefault();
            section.scrollIntoView({ behavior: 'smooth' });
        });

        outlineList.appendChild(link);
    });
}

// Scroll Spy Logic (Highlight active section in outline)
function setupScrollSpy(rootSelector = '#resume-view') {
    const sections = Array.from(document.querySelectorAll(`${rootSelector} h2`)).filter(section => section.offsetParent !== null);
    const outlineItems = document.querySelectorAll('.outline-item');

    if (!sections.length || !outlineItems.length) {
        return;
    }

    const observerOptions = {
        root: null,
        rootMargin: '-10% 0px -80% 0px', // Trigger when section is near top
        threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Remove active class from all
                outlineItems.forEach(item => item.classList.remove('active'));
                
                // Add active class to corresponding link
                const id = entry.target.id;
                const activeLink = document.querySelector(`.outline-item[href="#${id}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
            }
        });
    }, observerOptions);

    sections.forEach(section => observer.observe(section));
}

/*
 * Helper to animate elements out before hiding them,
 * and animate elements in after showing them.
 */
function animateTransition(hideElement, showElement, onComplete) {
    if (!hideElement || !showElement) {
        if (hideElement) hideElement.style.display = 'none';
        if (showElement) showElement.style.display = 'block';
        if (onComplete) onComplete();
        return;
    }

    // 1. Animate Out
    hideElement.classList.add('anim-fade-out');

    const handleOutEnd = () => {
        hideElement.classList.remove('anim-fade-out');
        hideElement.style.display = 'none';
        hideElement.removeEventListener('animationend', handleOutEnd);

        // 2. Switch
        showElement.style.display = 'block';
        showElement.classList.add('anim-fade-in');

        // 3. Animate In
        const handleInEnd = () => {
            showElement.classList.remove('anim-fade-in');
            showElement.removeEventListener('animationend', handleInEnd);
            if (onComplete) onComplete();
        };
        showElement.addEventListener('animationend', handleInEnd);
    };

    hideElement.addEventListener('animationend', handleOutEnd);
}
