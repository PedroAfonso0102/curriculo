// Translations & Content
const translations = {
    pt: {
        role: "Gestão Comercial & Desenvolvimento Digital",
        section_summary: "Resumo",
        summary_text: "Profissional com atuação híbrida em Gestão Comercial e Desenvolvimento Digital. Combino experiência prática em vendas consultivas de alto valor com competência técnica em desenvolvimento web e produção audiovisual. Foco em execução: utilizo dados para qualificar leads, crio ferramentas digitais para otimizar processos e produzo conteúdo visual para suporte direto a vendas. Orientado a eficiência operacional e resultados financeiros.",
        section_experience: "Experiência Profissional",
        job1_title: "Analista de Vendas e Processos",
        job1_desc1: "Gestão integral do ciclo de vendas de imóveis com ticket médio entre R$ 120k e R$ 2.5M, com atuação em ativos acima de R$ 13M.",
        job1_desc2: "Uso de análise de dados para filtragem de oportunidades no CRM, aumentando a taxa de conversão real do funil.",
        job1_desc3: "Reestruturação de processos de follow-up e atendimento, reduzindo o tempo operacional gasto por cliente.",
        job2_title: "Fundador e Presidente",
        job2_desc1: "Gestão Institucional: Fundou e estruturou juridicamente a entidade, liderando uma equipe operacional de 30 membros.",
        job2_desc2: "Controle Financeiro: Assumiu o caixa do zero e entregou a gestão com superávit líquido de +R$ 4.000 através de controle de custos e receita.",
        job2_desc3: "Execução de Projetos: Organizou e supervisionou a execução de eventos e projetos acadêmicos com foco em viabilidade econômica.",
        job3_title: "Produtor Digital e Desenvolvedor",
        job3_company: "Autônomo",
        job3_desc1: "Projetos Web: Desenvolvimento de interfaces e landing pages (HTML/CSS/JS) focadas em conversão e performance.",
        job3_desc2: "Produção Audiovisual: Edição e motion graphics (Premiere/After Effects) para comunicação corporativa e materiais de venda.",
        job3_desc3: "Automação: Criação de scripts e ferramentas simples para automação de tarefas repetitivas e organização de fluxo de trabalho.",
        job4_title: "Assistente de Importação",
        job4_desc1: "Comércio Exterior: Operacionalização de processos de importação/exportação e gestão de relacionamento com cadeia de suprimentos internacional.",
        section_skills: "Habilidades Técnicas",
        skill_cat1: "Design e Audiovisual",
        skill_cat2: "Negócios e Ferramentas",
        section_education: "Formação Acadêmica",
        edu1_title: "Relações Internacionais (Bacharelado)",
        edu2_title: "Técnico em Administração",
        section_languages: "Idiomas",
        lang1_name: "Português",
        lang1_details: "Nativo",
        lang2_name: "Inglês",
        lang2_details: "Fluente",
        lang3_name: "Espanhol",
        lang3_details: "Profissional",
        lang4_name: "Africâner",
        lang4_details: "Básico",
        tab_experiments: "Experimentos",
        tab_comex: "Notícias ComEx",
        tab_international: "Notícias Internacionais",
        tab_comex_title: "Notícias ComEx",
        tab_comex_desc: "Em breve: Feed de notícias sobre Comércio Exterior.",
        tab_intl_title: "Notícias Internacionais",
        tab_intl_desc: "Em breve: Feed de notícias internacionais."
    },
    en: {
        role: "Commercial Management & Digital Development",
        section_summary: "Summary",
        summary_text: "Hybrid professional in Commercial Management and Digital Development. I combine practical experience in high-value consultative sales with technical competence in web development and audiovisual production. Focus on execution: I use data to qualify leads, build digital tools to optimize processes, and produce visual content for direct sales support. Oriented towards operational efficiency and financial results.",
        section_experience: "Professional Experience",
        job1_title: "Sales & Process Analyst",
        job1_desc1: "Consultative Sales: Full management of the sales cycle for real estate assets ranging from R$ 120k to R$ 2.5M, handling assets exceeding R$ 13M.",
        job1_desc2: "Lead Qualification: Use of data analysis for opportunity filtering in CRM, increasing the funnel's actual conversion rate.",
        job1_desc3: "Routine Optimization: Restructuring of follow-up and service processes, reducing operational time spent per client.",
        job2_title: "Founder & President",
        job2_desc1: "Institutional Management: Founded and legally structured the entity, leading an operational team of 30 members.",
        job2_desc2: "Financial Control: Started with zero cash flow and delivered the tenure with a net surplus of +R$ 4,000 through cost and revenue control.",
        job2_desc3: "Project Execution: Organized and supervised the execution of events and academic projects focusing on economic viability.",
        job3_title: "Digital Producer & Developer",
        job3_company: "Freelance",
        job3_desc1: "Web Projects: Development of interfaces and landing pages (HTML/CSS/JS) focused on conversion and performance.",
        job3_desc2: "Audiovisual Production: Editing and motion graphics (Premiere/After Effects) for corporate communication and sales materials.",
        job3_desc3: "Automation: Creation of scripts and simple tools for automating repetitive tasks and organizing workflows.",
        job4_title: "Import Assistant",
        job4_desc1: "Foreign Trade: Operationalization of import/export processes and relationship management with the international supply chain.",
        section_skills: "Technical Skills",
        skill_cat1: "Design & Audiovisual",
        skill_cat2: "Business & Tools",
        section_education: "Education",
        edu1_title: "International Relations (Bachelor's)",
        edu2_title: "Business Administration Technician",
        section_languages: "Languages",
        lang1_name: "Portuguese",
        lang1_details: "Native",
        lang2_name: "English",
        lang2_details: "Fluent",
        lang3_name: "Spanish",
        lang3_details: "Professional",
        lang4_name: "Afrikaans",
        lang4_details: "Basic",
        tab_experiments: "Experiments",
        tab_comex: "ComEx News",
        tab_international: "International News",
        tab_comex_title: "ComEx News",
        tab_comex_desc: "Coming soon: Foreign Trade news feed.",
        tab_intl_title: "International News",
        tab_intl_desc: "Coming soon: International news feed."
    },
    es: {
        role: "Gestión Comercial y Desarrollo Digital",
        section_summary: "Resumen",
        summary_text: "Profesional con enfoque híbrido en Gestión Comercial y Desarrollo Digital. Combino experiencia práctica en ventas consultivas de alto valor con competencia técnica en desarrollo web y producción audiovisual. Enfoque en ejecución: utilizo datos para calificar leads, creo herramientas digitales para optimizar procesos y produzco contenido visual para soporte directo a ventas. Orientado a la eficiencia operativa y resultados financieros.",
        section_experience: "Experiencia Profesional",
        job1_title: "Analista de Ventas y Procesos",
        job1_desc1: "Ventas Consultivas: Gestión integral del ciclo de ventas de inmuebles con ticket medio entre R$ 120k y R$ 2.5M, actuando en activos superiores a R$ 13M.",
        job1_desc2: "Calificación de Leads: Uso de análisis de datos para filtrado de oportunidades en CRM, aumentando la tasa de conversión real del embudo.",
        job1_desc3: "Optimización de Rutina: Reestructuración de procesos de seguimiento y atención, reduciendo el tiempo operativo gastado por cliente.",
        job2_title: "Fundador y Presidente",
        job2_desc1: "Gestión Institucional: Fundó y estructuró legalmente la entidad, liderando un equipo operativo de 30 miembros.",
        job2_desc2: "Control Financiero: Asumió la caja desde cero y entregó la gestión con un superávit neto de +R$ 4.000 a través del control de costos e ingresos.",
        job2_desc3: "Ejecución de Proyectos: Organizó y supervisó la ejecución de eventos y proyectos académicos con enfoque en viabilidad económica.",
        job3_title: "Productor Digital y Desarrollador",
        job3_company: "Autónomo",
        job3_desc1: "Proyectos Web: Desarrollo de interfaces y landing pages (HTML/CSS/JS) enfocadas en conversión y rendimiento.",
        job3_desc2: "Producción Audiovisual: Edición y motion graphics (Premiere/After Effects) para comunicación corporativa y materiales de venta.",
        job3_desc3: "Automatización: Creación de scripts y herramientas simples para la automatización de tareas repetitivas y organización del flujo de trabajo.",
        job4_title: "Asistente de Importación",
        job4_desc1: "Comercio Exterior: Operacionalización de processos de importação/exportação e gestão de relações com a cadeia de suprimento internacional.",
        section_skills: "Habilidades Técnicas",
        skill_cat1: "Diseño y Audiovisual",
        skill_cat2: "Negocios y Herramientas",
        section_education: "Formación Académica",
        edu1_title: "Relaciones Internacionales (Licenciatura)",
        edu2_title: "Técnico em Administração",
        section_languages: "Idiomas",
        lang1_name: "Portugués",
        lang1_details: "Nativo",
        lang2_name: "Inglés",
        lang2_details: "Fluido",
        lang3_name: "Español",
        lang3_details: "Profesional",
        lang4_name: "Afrikáans",
        lang4_details: "Básico",
        tab_experiments: "Experimentos",
        tab_comex: "Noticias ComEx",
        tab_international: "Noticias Internacionales",
        tab_comex_title: "Noticias ComEx",
        tab_comex_desc: "Próximamente: Noticias sobre Comercio Exterior.",
        tab_intl_title: "Noticias Internacionales",
        tab_intl_desc: "Próximamente: Noticias internacionales."
    }
};

function setLanguage(lang) {
    document.documentElement.lang = lang;

    // Update buttons (Desktop & Mobile)
    document.querySelectorAll('.lang-btn').forEach(btn => {
        const isActive = btn.textContent.toLowerCase() === lang;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });

    // Update text
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang][key]) {
            element.innerHTML = translations[lang][key];
        }
    });
}

// Mobile Menu Logic
function toggleMobileMenu() {
    const overlay = document.getElementById('mobile-menu-overlay');
    const body = document.body;

    if (overlay.classList.contains('active')) {
        overlay.classList.remove('active');
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 200); // Wait for opacity transition
        body.classList.remove('menu-open');
    } else {
        overlay.style.display = 'block';
        // Force reflow
        void overlay.offsetWidth;
        overlay.classList.add('active');
        body.classList.add('menu-open');
    }
}

// Theme Toggle Logic
document.addEventListener('DOMContentLoaded', () => {
    const themeToggleBtns = document.querySelectorAll('.theme-toggle, .theme-btn-mobile');
    const htmlElement = document.documentElement;

    const applyTheme = (isDark, persist = false) => {
        htmlElement.classList.toggle('dark', isDark);
        if (persist) {
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        themeToggleBtns.forEach(btn => {
            btn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
            // Optional: Update text for mobile button if needed
            if (btn.classList.contains('theme-btn-mobile')) {
                btn.textContent = isDark ? 'Modo Claro' : 'Modo Escuro';
            }
        });
        window.dispatchEvent(new CustomEvent('themechange', { detail: { isDark } }));
    };

    const storedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialDark = storedTheme ? storedTheme === 'dark' : prefersDark;
    applyTheme(initialDark);

    if (!storedTheme && window.matchMedia) {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', (event) => applyTheme(event.matches));
    }

    themeToggleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const nextState = !htmlElement.classList.contains('dark');
            applyTheme(nextState, true);
        });
    });

    // Initialize language
    const initialLang = navigator.language ? navigator.language.slice(0,2) : 'pt';
    setLanguage(translations[initialLang] ? initialLang : 'pt');
});

// View Switching Logic
function switchView(viewName) {
    const resumeView = document.getElementById('resume-view');
    const playgroundView = document.getElementById('playground-view');
    
    // Update Top Bar & Mobile Links
    const updateLinks = (selector) => {
        document.querySelectorAll(selector).forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-view') === viewName) {
                btn.classList.add('active');
            }
        });
    };
    updateLinks('.nav-link');
    updateLinks('.mobile-link');

    const isResume = viewName === 'resume';
    const hideEl = isResume ? playgroundView : resumeView;
    const showEl = isResume ? resumeView : playgroundView;

    // Use transition helper
    animateTransition(hideEl, showEl, () => {
        if (isResume && window.Experiments) {
            if (typeof window.Experiments.stopCurrent === 'function') {
                window.Experiments.stopCurrent();
            }
        }
    });
}

// Utility: debounce
function debounce(fn, wait) {
    let t;
    return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
    };
}

// Experiment Logic
function openExperiment(type) {
    const dashboard = document.getElementById('playground-dashboard');
    const container = document.getElementById('experiment-container');
    const views = document.querySelectorAll('.experiment-view');
    const targetView = document.getElementById(`${type}-view`);

    if (!targetView) return;

    animateTransition(dashboard, container, () => {
        views.forEach(v => v.style.display = 'none');
        targetView.style.display = 'block';
        initExperimentLogic(type, targetView);
    });
}

function initExperimentLogic(type, view) {
        // Initialize experiment with options from controls
        const formatVal = (v) => {
            if (typeof v !== 'number') return v;
            if (Math.abs(v) >= 100) return Math.round(v);
            if (Math.abs(v) >= 1) return Math.round(v * 100) / 100;
            return parseFloat(v.toPrecision(4));
        };

        const readOptions = () => {
            const opts = {};
            const controls = view.querySelectorAll('.exp-control');
            controls.forEach(ctrl => {
                const name = ctrl.name;
                let val = ctrl.value;
                if (val !== undefined && val !== null && val !== '') {
                    if (val.indexOf('.') >= 0) val = parseFloat(val);
                    else val = parseFloat(val);
                }
                opts[name] = val;
                const label = view.querySelector(`#${type}-${name}-label`);
                if (label) label.textContent = formatVal(val);
            });
            return opts;
        };

        const startWithOptions = (opts) => {
            if (Experiments && Experiments[type]) {
                Experiments.stopCurrent();
                const result = Experiments[type](`${type}Canvas`, opts);

                if (typeof result === 'function') {
                    Experiments.currentInstance = { cleanup: result, setOptions: null };
                } else if (result && typeof result === 'object') {
                    Experiments.currentInstance = result;
                } else {
                    Experiments.currentInstance = null;
                }

                Experiments.activeId = type;
            }
        };

        startWithOptions(readOptions());

        if (view._expBound && Array.isArray(view._expBound)) {
            view._expBound.forEach(b => b.el.removeEventListener('input', b.handler));
        }
        const bound = [];
        view.querySelectorAll('.exp-control').forEach(ctrl => {
            const handler = debounce(() => {
                const opts = readOptions();
                if (Experiments && Experiments.currentInstance && typeof Experiments.currentInstance.setOptions === 'function') {
                    try {
                        const res = Experiments.currentInstance.setOptions(opts);
                        if (res && res.requiresReinit) {
                            startWithOptions(opts);
                        }
                        return;
                    } catch (err) {
                        console.warn('setOptions failed, reinitializing:', err);
                        startWithOptions(opts);
                        return;
                    }
                }
                startWithOptions(opts);
            }, 250);
            ctrl.addEventListener('input', handler);
            bound.push({ el: ctrl, handler });
        });
        view._expBound = bound;
}

function closeExperiment() {
    const dashboard = document.getElementById('playground-dashboard');
    const container = document.getElementById('experiment-container');
    
    animateTransition(container, dashboard, () => {
        const prevActive = Experiments ? Experiments.activeId : null;
        if (Experiments) Experiments.stopCurrent();
        if (prevActive) {
            const activeView = document.getElementById(`${prevActive}-view`);
            if (activeView && activeView._expBound) {
                activeView._expBound.forEach(b => b.el.removeEventListener('input', b.handler));
                activeView._expBound = null;
            }
        }
    });
}

function animateTransition(hideElement, showElement, onComplete) {
    const immediateSwitch = () => {
        if (hideElement) hideElement.style.display = 'none';
        if (showElement) showElement.style.display = 'block';
        if (onComplete) onComplete();
    };

    if (!hideElement || !showElement) {
        immediateSwitch();
        return;
    }

    const isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (isReducedMotion) {
        immediateSwitch();
        return;
    }

    hideElement.style.opacity = '0';
    hideElement.style.transform = 'translateY(10px)';
    hideElement.style.transition = 'opacity 0.2s ease, transform 0.2s ease';

    setTimeout(() => {
        hideElement.style.display = 'none';

        showElement.style.opacity = '0';
        showElement.style.transform = 'translateY(10px)';
        showElement.style.display = 'block';

        // Force Reflow
        void showElement.offsetWidth;

        showElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        showElement.style.opacity = '1';
        showElement.style.transform = 'translateY(0)';

        setTimeout(() => {
            if (onComplete) onComplete();
        }, 300);
    }, 200);
}

function switchPlaygroundTab(tabId) {
    const buttons = document.querySelectorAll('.pg-tab-btn');
    buttons.forEach(btn => {
        if (btn.getAttribute('onclick').includes(tabId)) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });

    const contents = document.querySelectorAll('.pg-tab-content');
    contents.forEach(content => {
        content.classList.remove('active');
    });

    const target = document.getElementById(`tab-${tabId}`);
    if (target) {
        target.classList.add('active');
    }
}

// Global Exports
window.openExperiment = openExperiment;
window.closeExperiment = closeExperiment;
window.switchView = switchView;
window.setLanguage = setLanguage;
window.switchPlaygroundTab = switchPlaygroundTab;
window.toggleMobileMenu = toggleMobileMenu;
